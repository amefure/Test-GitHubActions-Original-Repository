name: Sync Specific Branches to Repository B

on:
  push:
    branches:
      - "feature/release*"  # `feature/release*` ã«ä¸€è‡´ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’æ¤œçŸ¥

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Git ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ãƒªãƒã‚¸ãƒˆãƒªAã®ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±ã‚’å–å¾—
        run: |
          set -x  # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆå®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å‡ºåŠ›ï¼‰

          # `origin` ã«ãƒªãƒã‚¸ãƒˆãƒªAã‚’è¿½åŠ 
          git clone --bare https://github.com/amefure/Test-GitHubActions-Original-Repository.git repo-a
          cd repo-a

          # ã©ã®ãƒªãƒ¢ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          git remote -v  

          echo "ğŸ” ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆãƒ­ãƒ¼ã‚«ãƒ« & ãƒªãƒ¢ãƒ¼ãƒˆï¼‰:"
          git branch -a

          # `feature/release*` ã«ãƒãƒƒãƒã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã®ã¿å–å¾—
          echo "ğŸ” Fetching branches matching 'feature/release*'..."
          BRANCHES=$(git branch -r | grep -E 'origin/feature/release.*' | sed 's/origin\///')

          # å–å¾—ã—ãŸãƒ–ãƒ©ãƒ³ãƒåã‚’å‡ºåŠ›
          echo "âœ… Found branches: $BRANCHES"

          # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªBã‚’è¿½åŠ 
          git remote add target https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/amefure/Test-GitHubActions-Sync-Repository.git
          git remote -v  # è¿½åŠ å¾Œã®ãƒªãƒ¢ãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’ç¢ºèª

          # å„ãƒ–ãƒ©ãƒ³ãƒã‚’å€‹åˆ¥ã«ãƒ—ãƒƒã‚·ãƒ¥
          for BRANCH in $BRANCHES; do
            echo "ğŸš€ Processing branch: $BRANCH"

            # ãƒ–ãƒ©ãƒ³ãƒãŒç©ºã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if [ -z "$BRANCH" ]; then
              echo "âš ï¸ No matching branches found, skipping..."
              continue
            fi

            # `git fetch` ã®ãƒ­ã‚°ã‚’å‡ºåŠ›
            echo "ğŸ”„ Fetching branch $BRANCH from origin..."
            git fetch --verbose origin $BRANCH

            # `git push` ã®ãƒ­ã‚°ã‚’å‡ºåŠ›
            echo "ğŸ“¤ Pushing branch $BRANCH to target..."
            git push --verbose target $BRANCH
          done
